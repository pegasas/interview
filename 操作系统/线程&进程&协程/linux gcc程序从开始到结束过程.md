# 一个C语言程序到执行完文件的全过程

在linux里面用gcc编译的程序时，编译的过程可以细分为四个阶段：
（1）预处理（Pre-Processing）
（2）编译（Compiling）
（3）汇编（Assembling）
（4）链接（Linking）

1.在预处理阶段
“gcc -E test.c -o test.i”，其中，参数E告诉gcc命令值经行编译，不做其他的处理，用参数o指明输出的文件名为test.i。命令运行完毕后就会产生一个名为test.i的文件。
编译预处理主要是读取c源程序，对其中的伪指令（以#开头的指令）和特殊符号进行处理。
伪指令主要包括以下四个方面:  

（1）宏定义指令，如# define Name TokenString,#undef等。对于前一个伪指令，预编译所要作得的是将程序中的所有Name用TokenString替换，但作为字符串常量的Name则不被替换。对于后者，则将取消对某个宏的定义，使以后该串的出现不再被替换。
（2）条件编译指令，如#ifdef,#ifndef,#else,#elif,#endif,等等。这些伪指令的引入使得程序员可以通过定义不同的宏来决定编译程序对哪些代码进行处理。预编译程序将根据有关的文件，将那些不必要的代码过滤掉。
（3）头文件包含指令，如#include "FileName"或者#include <FileName>等。在头文件中一般用伪指令#define定义了大量的宏（最常见的是字符常量），同时包含有各种外部符号的声明。采用头文件的目的主要是为了使某些定义可以供多个不同的C源程序使用。因为在需要用到这些定义的C源程序中，只需加上一条#include语句即可，而不必再在此文件中将这些定义重复一遍。预编译程序将把头文件中的定义统统都加入到它所产生的输出文件中，以供编译程序对之进行处理。包含到c源程序中的头文件可以是系统提供的，这些头文件一般被放在/usr/include目录下。在程序中#include它们要使用尖括号（<>）。另外开发人员也可以定义自己的头文件，这些文件一般与c源程序放在同一目录下，此时在#include中要用双引号（""）。
（4）特殊符号，预编译程序可以识别一些特殊的符号。例如在源程序中出现的LINE标识将被解释为当前行号（十进制数），FILE则被解释为当前被编译的C源程序的名称。预编译程序对于在源程序中出现的这些串将用合适的值进行替换。
 预编译程序所完成的基本上是对源程序的“替代”工作。经过此种替代，生成一个没有宏定义、没有条件编译指令、没有特殊符号的输出文件。这个文件的含义同没有经过预处理的源文件。

2.编译阶段
“gcc - S test.i -o test.s”,其中参数S告诉gcc命令只进行编译，不做其他处理。命令运行完毕以后就会产生一个名为test.s的汇编文件。
编译阶段主要是经过预编译得到的输出文件中，将只有常量。如数字、字符串、变量的定义，以及C语言 的关键字，如main,if,else,for,while,{,},+,-,*,\，等等。预编译程序所要作得工作就是通过词法分析和语法分析，在确认所有的指令都符合语法规则之后，将其翻译成等价的中间代码表示或汇编代码。

3.汇编阶段
“gcc -c test.s -o test.o”,其中，参数c告诉gcc命令只进行汇编，不做其他处理。命令运行完毕后就会产生一个名为test.o的目标文件。

汇编过程主要的作用是汇编过程实际上指把汇编语言代码翻译成目标机器指令的过程。对于被翻译系统处理的每一个C语言源程序，都将最终经过这一处理而得到相应的目标文件。目标文件中所存放的也就是与源程序等效的目标的机器语言代码。目标文件由段组成。通常一个目标文件中至少有两个段：  代码段  该段中所包含的主要是程序的指令。该段一般是可读和可执行的，但一般却不可写。  数据段  主要存放程序中要用到的各种全局变量或静态的数据。一般数据段都是可读，可写，可执行的。

  UNIX环境下主要有三种类型的目标文件：  
（1）可重定位文件  其中包含有适合于其它目标文件链接来创建一个可执行的或者共享 的目标文件的代码和数据。
（2）共享的目标文件, 这种文件存放了适合于在两种上下文里链接的代码和数据。
第一种是链接程序可把它与其它可重定位文件及共享的目标文件一起处理来创建另一个目标文件；
第二种是动态链接程序将它与另一个可执行文件及其它的共享目标文件结合到一起，创建一个进程映象。
（3）可执行文件，它包含了一个可以被操作系统创建一个进程来执行之的文件。  汇编程序生成的实际上是第一种类型的目标文件。对于后两种还需要其他的一些处理方能

 得到，这个就是链接程序的工作了。

4.链接阶段
“gcc test.o -o test”,运行完成后就会产生一个名为test的可执行文件。

链接程序  由汇编程序生成的目标文件并不能立即就被执行，其中可能还有许多没有解决的问题。
例如，某个源文件中的函数可能引用了另一个源文件中定义的某个符号（如变量或者函数调用等）；在程序中可能调用了某个库文件中的函数，等等。所有的这些问题，都需要经链接程序的处理方能得以解决。链接程序的主要工作就是将有关的目标文件彼此相连接，也即将在一个文件中引用的符号 同该符号在另外一个文件中的定义连接起来，使得所有的这些目标文件成为一个能够被操作系统装入执行的统一整体。

对于链接：主要分为两种：静态链接和动态链接；
静态链接:后缀是.a，主要在编译的时候将库文件里面代码搬迁到可执行文件中；
动态链接：后缀是.so，主要在执行的时候将需要的库文件代码搬迁到可执行文件中；

两种链接的优缺点：
（1）静态的链接产生的可执行的文件体积比较的大；而动态链接的可执行文件的体积比较小；
（2）动态的链接的编译的效率比较的高；
（3）静态链接的可执行的文件执行的效率高
（4）静态链接的可执行的文件的“布局”比较好一点；
